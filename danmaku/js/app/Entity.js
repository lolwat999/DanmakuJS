define(["require","lib/Three","lib/eventemitter2","./Tasks"],function(a){var b=a("lib/Three"),c=a("lib/eventemitter2"),d=a("./Tasks"),e=Class.extend({family:"entity",type:"entity",init:function(a){_.extend(this,new c),this.set(a)},set:function(a){a=a||{},this.speed=a.speed||5,this.angle=a.angle||0,this.xSpeed=a.xSpeed||0,this.ySpeed=a.ySpeed||0,this.x=a.x||0,this.y=a.y||0,this.image=a.image;var c=e.imageMapCache.load("img/"+this.image);this.model=a.model||new b.Sprite({color:a.color||16777215,map:c,useScreenCoordinates:!1});var f=this.parent?this.parent.x:0,g=this.parent?this.parent.y:0;this.model.position.x=this.x+f,this.model.position.y=this.y+g,this.alive=!0,this.parent=a.parent||null,this.state=a.state||null,this.tasks=a.tasks?new d({tasks:a.tasks}):null,this.speedType=a.speedType||e.speedTypes.CARTESIAN,this.angleToRotation=a.angleToRotation||!1,this.disableTasks=!1,this.xScale=a.xScale||a.scale||1,this.yScale=a.yScale||a.scale||1,this.hitboxScale=a.hitboxScale||1,this.angleOffset=a.angleOffset||0;if(a.events)for(var h in a.events)a.events.hasOwnProperty(h)&&this.on(h,a.events[h])},add:function(a){this.state&&(a.parent=a.parent||this,this.state.add(a))},remove:function(a){this.state&&this.state.remove(a)},update:function(a){var b=this.parent?this.parent.x:0,c=this.parent?this.parent.y:0,d=(this.angle+this.angleOffset)*(Math.PI/180),f=this.getSize();this.speedType===e.speedTypes.POLAR&&(this.xSpeed=this.speed*Math.cos(d),this.ySpeed=this.speed*Math.sin(d)),this.model.rotation=Math.PI*2-d,this.x+=this.xSpeed*a*50,this.y-=this.ySpeed*a*50,this.model.position.x=this.x+b,this.model.position.y=this.y+c;var g=this.model.map.image.width/this.model.map.image.height;this.model.scale.x=this.xScale*g,this.model.scale.y=this.yScale,!this.disableTasks&&this.tasks&&this.tasks.update(a,this)},getType:function(){return this.type},getSize:function(){if(this.model){var a=this;return{x:a.model.map.image.width*a.xScale,y:a.model.map.image.height*a.yScale}}return{x:0,y:0}},outOfBounds:function(a,b){if(this.state&&this.state.gameArea){var c=this.state.gameArea,d=this.getSize(),e=this.x,f=this.y;return a=a||0,b=b||2,e+a<c.x+d.x/b||f+a<c.y+d.y/b||e-a>c.width+c.x+d.x/b||f-a>c.height+c.y-d.y/b}return!1},stayInBounds:function(){if(this.state&&this.state.gameArea){var a=this.x,b=this.y,c=this.getSize(),d=this.state.gameArea;a<d.x+c.x?this.x=d.x+c.x:a>d.width+d.x-c.x&&(this.x=d.width+d.x-c.x),b<d.y+c.y/2?this.y=d.y+c.y/2:b>d.height+d.y-c.y&&(this.y=d.height+d.y-c.y),this.model&&(this.model.position.x=this.x,this.model.position.y=this.y)}},getHitbox:function(a,b){var c=this.getSize(),d=this.hitboxScale;return a=a||c.x*d,b=b||c.y*d,{x:-a/2,y:-b/2,width:a,height:b}},collides:function(a){if(a.canCollide){var b=this.hitbox||this.getHitbox(),c=a.hitbox||a.getHitbox(),d=b.x+this.x,e=c.x+a.x,f=b.y+this.y,g=c.y+a.y,h=d+b.width,i=e+c.width,j=f+b.height,k=g+c.height;return!(d>i||f>k||h<e||j<g)}return!1}});return e.imageMapCache={images:{},load:function(a){return this.images[a]=this.images[a]||b.ImageUtils.loadTexture(a),this.images[a]}},e.speedTypes={POLAR:0,CARTESIAN:1},e})